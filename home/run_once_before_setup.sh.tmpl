#!/bin/bash
# =============================================================================
# Dotfiles Setup - System packages + mise
# =============================================================================
set -eu

echo "üöÄ Setting up dotfiles..."

# =============================================================================
# 1. System packages (minimum required)
# =============================================================================
{{ if eq .chezmoi.os "darwin" -}}
if ! command -v brew &> /dev/null; then
    echo "üç∫ Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi
brew update && brew bundle --file="{{ .chezmoi.sourceDir }}/dot_config/brewfile/Brewfile" || true

{{ else if eq .chezmoi.os "linux" -}}
{{ if or (eq .chezmoi.osRelease.id "ubuntu") (eq .chezmoi.osRelease.id "debian") -}}
sudo apt update && sudo apt install -y build-essential curl git tmux trash-cli unzip wget zsh
{{ else if eq .chezmoi.osRelease.id "fedora" -}}
sudo dnf install -y curl git tmux trash-cli unzip wget zsh
{{ else if eq .chezmoi.osRelease.id "arch" -}}
sudo pacman -Syu --noconfirm && sudo pacman -S --noconfirm base-devel curl git tmux trash-cli unzip wget zsh
{{ end -}}

# Install mise
command -v mise &> /dev/null || curl https://mise.run | sh
{{ end -}}

# =============================================================================
# 2. mise - Install all tools
# =============================================================================
export PATH="$HOME/.local/bin:$PATH"
if command -v mise &> /dev/null; then
    echo "üì¶ Installing tools via mise..."
    mise trust ~/.config/mise/config.toml 2>/dev/null || true
    mise install --yes
fi

# =============================================================================
# 3. Prezto (zsh framework)
# =============================================================================
ZPREZTO="${HOME}/.zprezto"
if [ ! -d "$ZPREZTO" ]; then
    echo "üêö Installing Prezto..."
    git clone --recursive https://github.com/sorin-ionescu/prezto.git "$ZPREZTO"
fi

echo "‚úÖ Setup complete! Run: exec \$SHELL"
